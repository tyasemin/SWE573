<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8" />
  <title>Board Detail</title>
  <link rel="stylesheet" href="{% static 'profile_app/profile.css' %}">
  <style>
#network-wrapper {
  position: relative;
  width: 100%;
  max-width: 853px;
  aspect-ratio: 853 / 721;
  border-radius: 10px;
  overflow: hidden; 
  margin: 20px auto;
}

#network-background {
  position: absolute;
  inset: 0;
  background-image: url("{% static 'board_app/images/template_board.png' %}");
  background-size: 100% 100%;   
  background-repeat: no-repeat;
  background-position: center;
  z-index: 0;
}

#network {
  position: absolute;
  inset: 0;          
  width: 100%;
  height: 100%;
  z-index: 1;
}
</style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <ul>
      <li class = "active">
       <a href="{% url 'home' %}" style="text-decoration: none;">
        <button type="button">
          <img src="{% static 'profile_app/icons/home.svg' %}" alt="Home icon" class="icon" />
          Home
        </button>
      </a>
      </li>
      <li>
        <button>
          <img src="{% static 'profile_app/icons/popular.svg' %}" alt="Popular icon" class="icon">
          Popular
        </button>
      </li>
      <li>
        <button>
          <img src="{% static 'profile_app/icons/boards.svg' %}" alt="Boards icon" class="icon">
          Boards
        </button>
      </li>
      <li>
        <button>
          <img src="{% static 'profile_app/icons/nodes.svg' %}" alt="Nodes icon" class="icon">
          Nodes
        </button>
      </li>
      <li class>
        <form method="post" action="{% url 'profile' %}">
          {% csrf_token %}
          <button type="submit">
            <img src="{% static 'profile_app/icons/profile.svg' %}" alt="Profile icon" class="icon" />
            Profile
          </button>
        </form>
      </li>
      <li class="logout">
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit" class="icon">
            <img src="{% static 'profile_app/icons/logout.svg' %}" alt="Logout icon" class="icon" />
            Logout
          </button>
        </form>
        
      </li>      
    </ul>
  </div>

<div class ="main-container">
    <div class="latest-boards">
    <div class="board-card">
        <div class="board-card-top">
        <div class="board-card-content">
            <h2 class="board-title">{{ board.title }}</h2>
        </div>
        </div>

        
        <div id="network-wrapper">
        <div id="network-background"></div>
        <div id="network"></div>
        </div>

        <!-- Vis.js  -->
        <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

        <!-- JavaScript -->
        <script>
        document.addEventListener("DOMContentLoaded", function () {
        // âž• Add Node modal aÃ§/kapat
        const addNodeBtn = document.getElementById('addNodeBtn');
        const cancelNodeBtn = document.getElementById('cancelNodeBtn');
        const nodeModal = document.getElementById('nodeModal');

        if (addNodeBtn && cancelNodeBtn && nodeModal) {
            addNodeBtn.addEventListener('click', () => {
            nodeModal.style.display = 'block';
            });

            cancelNodeBtn.addEventListener('click', () => {
            nodeModal.style.display = 'none';
            });
        }

        //
        const rawNodes = JSON.parse('{{ nodes_json|escapejs }}');
        const rawEdges = JSON.parse('{{ edges_json|escapejs }}');

        // 
        const nodes = new vis.DataSet(
            rawNodes.map((node) => ({
            id: node.id,
            label: node.label,
            shape: 'image',
            image: "{% static 'board_app/images/thumbtackpaper/1.png' %}",
            size: 60,
            font: {
                size: 10,
                color: '#000',
                vadjust: -70,
                align: 'center'
            },
            title: node.description
            }))
        );

        const edges = new vis.DataSet(rawEdges); // baÄŸlantÄ±lar sonra

       
        const container = document.getElementById('network');
        if (container) {
            const data = { nodes, edges };

            const options = {
            layout: { improvedLayout: true },
            physics: {
                enabled: true,
                stabilization: true,
                solver: 'forceAtlas2Based',
                forceAtlas2Based: {
                springLength: 250 
                }
            },
            interaction: {
                dragView: true,
                zoomView: true
            },
            nodes: {
                shapeProperties: {
                useImageSize: false
                }
            },
            edges: {
                arrows: 'to',
                font: { align: 'middle' }
            }
            };

            const network = new vis.Network(container, data, options);

            const panBounds = {
            left: -426,
            right: 426,
            top: -360,
            bottom: 360,
            zoomMin: 0.2,
            zoomMax: 2
            };

            // GÃ¶rÃ¼ntÃ¼leme alanÄ± sÄ±nÄ±rlamasÄ±
            network.on("beforeDrawing", function () {
            const view = network.getViewPosition();
            const scale = network.getScale();

            const newX = Math.max(panBounds.left, Math.min(view.x, panBounds.right));
            const newY = Math.max(panBounds.top, Math.min(view.y, panBounds.bottom));

            if (
                view.x !== newX ||
                view.y !== newY ||
                scale < panBounds.zoomMin ||
                scale > panBounds.zoomMax
            ) {
                network.moveTo({
                position: { x: newX, y: newY },
                scale: Math.min(Math.max(scale, panBounds.zoomMin), panBounds.zoomMax),
                animation: false
                });
            }
            });
        }
        });
        </script>

        <div class="board-card-meta">
        <div class="icon-group">
            <span class="icon-item">
            <img src="{% static 'profile_app/icons/noconnections.svg' %}" class="inline-icon" />
            {{ board.number_of_connections|default:0 }}
            </span>
            <span class="icon-item">
            <img src="{% static 'profile_app/icons/nonodes.svg' %}" class="inline-icon" />
            {{ board.number_of_nodes|default:0 }}
            </span>
        </div>
        </div>

    </div>
    <!-- Add Node Button -->
    <button id="addNodeBtn" style="margin: 20px;">âž• Add Node</button>
    </div>

    <!-- Modal -->
    <label for="nodeTitle">Title:</label><br>
    <input type="text" id="nodeTitle" name="title" required style="width: 100%; margin-bottom: 10px;"><br>

    <button type="button" id="wikidataBtn">ðŸ”Ž Wikidata Analyse</button><br><br>

    <div id="wikidataResults" style="display: none; margin-bottom: 10px;">
    <label>Select description:</label><br>
    <select id="wikidataDescriptionSelect" style="width: 100%;"></select>
    </div>

    <textarea id="nodeDescription" name="description" rows="3" style="width: 100%; margin-bottom: 10px;" placeholder="Optional description"></textarea>
    <input type="hidden" name="wikidata_description" id="wikidataDescriptionInput">

    <!--Javascript-->
    <script>
    document.getElementById('wikidataBtn').addEventListener('click', function () {
    const title = document.getElementById('nodeTitle').value;
    if (!title) {
        alert("Please enter a title first.");
        return;
    }

    fetch(`https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(title)}&language=en&format=json&origin=*`)
        .then(response => response.json())
        .then(data => {
        const select = document.getElementById('wikidataDescriptionSelect');
        select.innerHTML = '';  // temizle

        if (data.search.length === 0) {
            select.innerHTML = '<option>No results found</option>';
        } else {
            data.search.forEach(item => {
            const option = document.createElement('option');
            option.value = item.description || '';
            option.text = `${item.label} â€” ${item.description || 'No description'}`;
            select.appendChild(option);
            });

            document.getElementById('wikidataResults').style.display = 'block';

            // SeÃ§ilen aÃ§Ä±klamayÄ± gizli input'a yaz
            select.addEventListener('change', function () {
            document.getElementById('wikidataDescriptionInput').value = this.value;
            });

            // ilk seÃ§enek otomatik ekle
            document.getElementById('wikidataDescriptionInput').value = select.value;
        }
        })
        .catch(error => {
        console.error("Wikidata fetch error:", error);
        alert("Failed to fetch from Wikidata.");
        });
    });
    </script>
    


</div>
</body>
</html>
